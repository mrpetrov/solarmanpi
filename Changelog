3.3 2015-08-28
Enable PUMP2 (solar) operation.
Lower solar pump idle time from 4 hours to 30 minutes during daytime.
Remove rising temps from solar pump control logic - only make it try to 
increase boiler temps to 52 C. Requires 6 C higher temps of solar when
compared to boiler high temp.
Make solar pump run in "pulses" - constant run is turned to 1 minute run time
and 30 seconds pauses.
Only activate furnace temp raising logic if outside is colder.

3.2 2015-05-12
Make solard shout-out on start-up if for whatever reason one of the required
log files cannot be opened.
MAX_TEMP_DIFF increased to 5 C - the allowed change in sensor value between
reads.
ReadSensors() now uses the previous sensor value data as current if the newly
read is bigger or smaller than MAX_TEMP_DIFF*2(=10 C), and counts it as a
sensor read error. This way one-off cases are handled way better, and system
will eventually shut down if too much of these happen at once.
Electric heater use will be prevented by AdjustHeatingModeForBatteryPower(HM)
during grid power outages.

3.1 2015-04-27
Fixed a few syntax errors that were causing solard to behave annoyingly -
human readable cycles calculations should be enclosed in braces, like so:
10 sec * 6 - to get a minute * 60 - to get an hour, etc should be written
like X % (6*60) and NOT LIKE X % 6*60 ! That last one caused solard to
misbehave, but that is clearly wrong calculation, so if it were used at
some place important - who knows what could have happened...
Increased boiler electrical heater minimum on time to 2 minutes at a time.
Changed the done start cycles for both pumps so if a restart happens even
though everything is calm in the system, the pumps get a little workout.
Modified GetCurrentTime() to log the new hours after adjustment, and only
do so when they are actually changed, but not every day as would have been
done with the previous code. Initial hours are also such that change should
be done upon start up, so if there is no trace in logs - something is wrong.
Introduced two new "mode"s: 7 and 8. They turn on the electrical heater if
there is need to heat the boiler up, respectively obeying the allowed hours
or DISREGARDING them. Useful if the pumps and valve need to be shut off, but
the boiler still stay in use, for example if a pump or the valve needs to be
sent for servicing. Follows the "mode"s description in full:
 # mode: 0=ALL OFF; 1=AUTO; 2=AUTO+HEAT HOUSE BY SOLAR; 3=MANUAL PUMP1 ONLY;
 # mode: 4=MANUAL PUMP2 ONLY; 5=MANUAL HEATER ONLY; 6=MANAUL PUMP1+HEATER
 # mode: 7=AUTO ELECTICAL HEATER ONLY - this one obeys start/stop hours
 # mode: 8=AUTO ELECTICAL HEATER ONLY, DOES NOT CARE ABOUT SCHEDULE !!!
With these extra AUTO* modes, the manual modes can be avoided, and in doing
so - the accounting for the electric power use will stay accurate.
solard now uses new defaults if no config file is found:
  mode=1
  wanted_T=46
  use_electric_start_hour=3
  use_electric_stop_hour=6
  keep_pump1_on=0

3.0 2015-04-26
Taught solard to keep track of current month and adjust the two variables
holding the night tariff electricity rate start and stop hours. These
variables get adjusted on program start and once every day between 8:00 and
9:00 in GetCurrentTime(), which is called to get current hour every 5 minutes.
It now stores the extracted month in a new global current_month variable.
For the above to work - there is another new global variable introduced -
ProgramRunCycles is an unsigned long, which stores the number of 10 second
cycles that the program has been running since start, and its only
increasing, so it will wrap around every 1362 years of run time ;)
GetCurrentTime() will also log an "INFO" notice for monit to pick-up when
it adjusts the night tariff hours.

2.9 2015-04-24
Fixed a bunch of text messages to be caught by the notification system.
Improved the error case handling in several places throughout the file.
To distinguish easier between heating mode and idle mode - in auto modes
the main loop now logs idle modes as 32+ - actual bits remain the same,
just an idle bit 6 (equals 32) is set.

2.8 2015-04-23
Removed unused #defines. Now got some solar logic in place - but until I
get it installed, along with its pump - its all theoretical.
Minimum electrical heater ON time introduced - 1 minute, this should lower the
frequency of heater relay triggering when boiler temp is near desired and using
electricity.
Main loop now checks gettimeofday() for errors and if there is trouble -
warnings are printed in the log file.
Adjusted furnace pump always-on temp from 60 C to 52 C.
Turn the Grundfoss UPS2 pump on every 4 hours - lets hope this will make it
start right away when its asked to.
Rearranged config file modes:
    # mode: 0=ALL OFF; 1=AUTO; 2=AUTO+HEAT HOUSE BY SOLAR; 3=MANUAL PUMP1 ONLY;
    # mode: 4=MANUAL PUMP2 ONLY; 5=MANUAL HEATER ONLY; 6=MANAUL PUMP1+HEATER
Main loop now calls AdjustHeatingModeForBatteryPower(), but it will only
log events - no turning things on or off.
Tweaked parse_config() to allow 0 as hour for start and stop of electric power
use.

2.7 2015-04-21
Now printing the hard-coded constants for the power usage of all the used
electrical consumers on start-up.
Another change is to only toggle valve state if it has been off for 1 minutes
or on for 4 minutes.
The pump will now stay on for 1 minute after the valve has stated closing -
this way, while the valve is open - the fluid will flow through it.
IdleSelect routine now has a mode where it builds up boiler heat from furnace
while its hot, so it will not need to use electricity later on - this mode
triggers if the furnace is more than 6 C hotter than the boiler high temp,
which should be hotter than the temp desired.
Current furnace sensor position is a bit questionable, so lower furnace
critical temp to 72 C - sensor is reading 5 C lower due to its placing.
While at it - change solar critical temp too - now its 85 C, and if need be -
it can be lifted back up again, safer this way...

2.6 2015-04-20
Several temperature triggering adjustments: first - there seems to be no point
in trying to heat the boiler with the serpentine with only 1.5 C more - so,
increase the difference required to use the furnace to 4 C; solar get used if
its at 8 C more than boiler; if furnace is above 60 C - always turn the pump on
as this is where the temps get critical, but they are not there yet, so this
will help keep things under control; furnace pump turn on temps are now as
follows: quickly heating - from 22 C, slowly heating - from 36 C, and finally
- if heating above 45 C.
In main SelectHeatingMode() only turn the electric heater after the valve is
absolutely sure to be closed.
Now allowing the colder end of the boiler to get to temp wanted + 1 C while
heating it up on electricity - it was a bit sluggish in reaching target temp
on the hot end otherwise.
Fixed electricity night tariff hours to start from 23:00 to 05:59 - it was a
bit off.
Electrical heater minimum off time is now 5 minutes.

2.5 2015-04-19
Changed how electrical power used gets handled by solard - now we have two
separate float variables TotalPowerUsed and NightlyPowerUsed which get updated
at every call to ActivateHeatingMode() accordingly. Night tariff is hard-coded
to between 23:00 and 06:59. The constants HEATERPPC, PUMPPPC, VAVLEPPC and
SELFPPC have the watt-hour electrical power used for 10 seconds of operation
for the electrical heater, pumps, valve and the Pi system itself.
The human readable data log file is renamed to "/run/shm/solard_data.log". It
now shows both power meters.
The array ctrlstatecycles[] is back to 5 cells.
BoilerHeating() adjusted to trigger if temperature Wanted > Previous > Current,
if there is less than 0.3 C to the temp wanted. Also, it wont trigger if the
colder end of the boiler is as hot as temp wanted.
Electrical heater minimum off time is now 2 minutes.

2.4 2015-04-18
solard now records the electrical power used since started. This is done by
growing ctrlstatecycles[] array to 6 cells where the sixth one is being used
to store the number of 10 seconds cycles with electric power on. Actual power
used in watts per 10 seconds is hard-coded to 8.34 W for 3 kW electrical heater
in the constant POWERPERCYCLE - adjust it according to your actual heater power.
LogData() was optimized to write data including new usage counter to the log
file in one go instead of open, write, close for each of the 11 written data
tokens. Also, the human-readable CSV file now shows watts used.
Restarting the collectd daemon is needed, so a new RRD file can be created.

2.3 2015-04-16
Fixed "emergency heat transfer" to actually do its thing - it was b0rken and
now it will work as intended, plus there is less code now.
Moved the max temp difference allowed between reads to a separate #define.
Fixed furnace pump periodic turn on to actually trigger every 7 days.
Solar pump is turned on every 4 hours between 05:00 and 0:00 - this should
keep the vacuum tubes of the solar panel filled with water during the hot
days. NOTE May need extra attention when the panel get installed later.
Lowered the temp difference required to use the solar panel to heat up the
house to 10 C in mode=2.
Changed BoilerHeatingNeeded() to trigger only if current AND previous boiler
hot end temps are both lower than the temp wanted.
Removed the _Prev cells from controls[] array for both pumps, valve and heater
- they were not used anywhere, anyway...

2.2 2015-04-15
Completely rewritten mode selection code - its now bit based, and much easier
to read.
Introduced 2 new manual modes: mode=4 turns on pump 1 only and mode=5 turns
on pump 2 only.
Fixed a few typos. Disabled the pumps toggling on switch to battery power -
this needs monitoring to see how the pumps fare without proper power
management.
Electric heater now has a minimum OFF time of 1 minute before being allowed
to be turned back on.
Adjusted idle mode pump control: if furnace is hot (> 44 C) - even slight
increase in temp will turn pump on; if furnace is warm (> 38 C) - there needs
to be a ~0.12 C increase to trigger pump on; and last - if furnace is cold, but
warming quickly, e.i. > 24 C but increasing by ~0.24 C per 10 seconds - the
pump will be turned on.
Allow temp changes of maximum 4 C - the previous change to 3 C max was not
sufficient after all...

2.1
Furnace is being protected from freezing if its less than 9 C now.
Changed is the idle mode pump control: now there are 3 stages; if furnace is
hot (> 46 C) - even slight increase in temp will turn pump on; if furnace is
warm (> 38 C) - there needs to be a 0.1 C increase to trigger pump on; and
last - if furnace is cold, but warming quickly, e.i. > 24 C but increasing
by 0.5 C per 10 seconds - the pump will be turned on. That way, we move
mostly hot water in the house heating system, and protect the furnace from
severe heating shocks.

2.0
Fix some printed texts and allow temp changes of maximum 3 C - it turns out
that 2 C is too small for 10 seconds at times, so allow for a bit more.

1.9
ReadSensors() now makes corrections upon too wild data of max 2 C. It also
is a lot more informative for the corrections in the log file.
Changed the diff required between furnace temp and boiler to 1.5 C to use as
a heat source.
Critical temps changes: max boiler t=70, max furnace t=77, max solar temp=88

1.8 2015-04-11
Fixed some typos. Added _Prev vars for temperature sensor readings and the
controls[] array. The controls[] array also got a new ctrlstatecycles[5]
array which will count the 10 second cycles spent in the last state; zeroed
upon change of state. Added sensible init values to said arrays.
Tweaked ReadSensors() to log a warning when it hits trouble, and to
deal nicely with too wild changes to sensor data, i.e. it now makes
changes no bigger than 3 degrees C, and logs when it corrects data. It only
takes raw data in upon startup - there is a var just_started to allow this.
Changed the format of the data in solar_data.csv - now its easier to read,
and it also contains the used HeatingMode/IdleMode.
Critical temps changes: max boiler t=77, max solar temp=90

1.7 2015-04-10
Don't bother turning the solar pump on for now - it is absent anyway.
New config mode introduced:
mode=3
forces only furnace pump ON.
Changed temp diff requirements: solar comes on if at least 8 degrees C hotter,
was 5 C; furnace now needs 5 C more than boiler, was 3 C. And all boiler
comparisons now use the hotter sensor, which sadly is placed too low, but for
now will have to do.
So, currently the system practically controls boiler valve opening and logs
the temps.

EOF
